# CL-004: Race window analysis

**Risk**: Data corruption

**When to check**: Mandatory when concurrent access to shared datastructures is possible

**Pattern-specific TodoWrite fields**:
- Critical section: [file:line to line]
- Shared data accessed: [variable/struct names]
- Exclusion mechanism: Type [lock/RCU/atomic/NONE], Details [which lock, RCU flavor]
- Race proof: Can occur in practice [YES/NO], Proof [show racing paths]
- Normal execution trace: [describe without interruption]
- Race scenarios tested: Interruption point [line] - [what could interrupt] - [impact]
- Parallel execution: [concurrent paths], Compiler reordering: [assignments] - [barriers?]
- Patch changes to race windows: [new/removed race possibilities]

**Mandatory race window validation:**
- read entire functions when concurrent access to shared datastructures is possible
- create TodoWrite items to track all concurrent access to shared datastructures in modified functions, even if they didn't change
- verify proper exclusion exists (rcu, locking etc)
- race windows need hard proof showing that both sides of the race can occur in practice
  - do not worry about theoretical races, only proven races

**Mandatory race window testing:**
- add a TodoWrite for every critical section
- trace normal execution without interruption
- trace potential races assuming interruptions or concurrency at every point in the critical section
- think about changes introduced by the patch to potential interruptions or concurrency in the critical section
- think about parallel execution at every step of unlocked access
- think about compiler reordering of assignments:
  - fooA = fooB; fooC = fooD; might be reordered without barriers in place

**Mandatory Self-verification gate:**

**Pattern-specific questions** (in addition to core questions):
  1. How many critical sections did you analyze? [number]
  2. How many accesses lack proper exclusion? [number]
  3. Have you proven races can occur in practice (not theoretical)? [yes/no - how many proven races]
  4. Have you traced interruptions at EVERY point in critical sections? [yes/no]

If you cannot answer ALL questions with evidence, RESTART CL-004 from the beginning.
