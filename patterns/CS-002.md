# CS-002: Caller analysis (up the stack)

**Risk**: Mishandled return values, lock state mismatches, resource state violations

**When to check**: Required for all non-trivial changes

**Pattern-specific TodoWrite fields**:
- Caller chain traced (recursive): Level 1 (direct): [callerA at line], Level 2 (propagating): [callerC] propagates from [callerA]
- Locks held at return per caller: [callerA] holds [locks] - [matches expectation? YES/NO]
- Lock changes: [locks dropped/reacquired] - [state revalidated? YES/NO]
- Return value handling: [callerA] checks [NULL/ERR_PTR/negative/positive] - [all variants? YES/NO]
- Return propagation: [callerC] propagates to [callerD] - [tracked recursively? YES/NO]
- Resource state expectations: [callerA] passes [resource1] - Expects [describe], Actually [describe], Match [YES/NO]

**Mandatory call tracking:**
- You must create a TodoWrite (named caller_tracking) with all callers
- step tracking.1: identify all direct callers, track in TodoWrite
- step tracking.2: for each caller, load function definition
- step tracking.3: for callers that propagate return value, add their callers to TodoWrite
- step tracking.5: repeat recursively until no more propagation
- step tracking.6: apply all checks below to every caller
- Do not skip any callers

**Mandatory locking verification**:
- You must track locks held at return time
- track all locks through callers even if they didn't change
- step locking.1: Create a TodoWrite tracking all locks held at return time for
  every call tracked in caller_tracking TodoWrite
- step locking.2: make sure all locks from locking.1 match caller expectation
- step locking.3: if locks are changed or dropped ruing the call,
  make sure caller properly revalidates state under the new lock

**Mandatory return value validation**:
- You must track and validate every return value
- track all return values through callers, even if they didn't change
- step return.1: For each caller from caller_tracking TodoWrite, verify all return values handled properly
  - it is not sufficient to simply check a return value, must check all possible variations.
  - ex: NULL, ERR_PTR(), negative error values vs positive status etc
- step return.2: For callers that propagate return value, make sure they are tracked in TodoWrite
- step return.4: Repeat recursively until no more propagation
- do not skip any callers

**Mandatory caller expectation validation**:
- You must verify that caller expectations about resource state match function behavior
- track all expectations through callers, even if they didn't change
- step state.1: Track all resources passed in calls tracked by caller_tracking in a TodoWrite
- step state.2: Track all changes to those resources in a TodoWrite
- step state.3: Verify all changes match caller expectations

**Mandatory Self-verification gate:**

**Pattern-specific questions**:
  1. Have you traced recursively until no more return value propagation? [yes/no]
  2. How many callers have mismatched lock expectations? [number]
  3. How many callers do NOT handle all return value variants? [number]
  4. Have you verified resource state expectations for EVERY caller? [yes/no]
  5. How many callers have resource state mismatches? [number]

If you cannot answer ALL questions with evidence, RESTART CS-002 from the beginning.
