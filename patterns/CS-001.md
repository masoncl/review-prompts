# CS-001: Callee analysis (down the stack)

**Risk**: Lock violations, resource leaks, uninitialized variables

**When to check**: Required for all non-trivial changes

**Background knowledge:**

Read patterns/null.md for NULL pointer dereference guidance.

Note: foo->ptr dereferences foo BUT NOT ptr

null.md loaded and read? [ y / n ]

Place each step defined below into TodoWrite.

**Callee traversal process**:
- Step callee.1: Identify all direct callees in modified functions
  - We gather the callees because even small changes in functions can
    cause bugs in the functions they call.  The only way to know is to
    actually read the functions in the callstack.
  - The semcode diff_functions call did not list callees, you have to find
    for each function you've already gathered
  - Place callees into TodoWrite, even if they were outside the modified part of the function
  - Place callees into TodoWrite, even if they were not modified
- Step callee.2: For each callee, load entire function definition
  - Output: The callee function names, and a random line from anywhere in each definition
    - you must prove you read the callee
- Step callee.3: Trace 2-3 levels deep as needed
  - Place each additional callee into TodoWrite
  - Again, small changes higher up in the stack can introduce bugs lower
    down.  You cannot review code effectively without looking at the call stack,
    even for changes that you think you understand.
- Step callee.4: Apply all checks below to each callee in the chain
  - Output: The callee function names, and a random line from anywhere in each definition
    - you must prove you read the callee

Caller traversal process:
- step caller.1: identify all direct callers
  - We gather the callers because even small changes can introduce bugs
    in the functions that call them.  The only way to know is to actually
    read the functions in the callstack.
  - Place into TodoWrite, even if they were not modified
- step caller.2: for each caller, load function definition
  - Output: caller name, size in lines
  - Output: The caller function names, and a random line from anywhere in each definition
    - you must prove you read the callers
- step caller.3: for callers that propagate return value, trace their callers
  - Again, changes and errors can propagate up in surprising ways.  You
    need to read the callers.
  - Place additional callers into TodoWrite
- step caller.4: apply all checks below to every caller
  - Output: The caller function names, and a random line from anywhere in each definition
    - you must prove you read the callers

**Mandatory Lock requirements**:
- step lock.1: Verify proper locks are held based on requirements in every tracked function
  - Output: locks required
- step lock.2: Ensure functions take and release locks as expected by caller
- step lock.3: If locks are changed or dropped during the call, verify code properly revalidates state
- step lock.4: Ensure caller provides all locks required by callees

**Mandatory locking in error path validation**:
- step lock.5: For every lock acquired, trace error paths ensuring locks properly released/handed off
  - Output: locations of all error paths

**Mandatory resource propagation validation**:
- step resource.1: Trace resource ownership through function boundaries
- step resource.2: For allocations (kmalloc/kcalloc/kzalloc/vmalloc):
  - If size parameter can be 0, report potential ZERO_SIZE_PTR crash
- step resource.3: For multiple pointers to same memory: track how writes through one affect others
  - Reference as MULTI_POINTER_MEMORY_TRACKING in later patterns
  - Output: list of pointers you found for the same memory
  - NOTE: this tracking is use in other prompts, you must perform it.
- step resource.4: Verify resources are properly initialized, locked, and freed

**Mandatory initialization validation**:
- step init.1: Ensure variables and fields are initialized before reading
  - Output: list of variables initialized before reading
- step init.2: Writing to a variable counts as initializing it

**After analysis:** Issues found: [none OR list]

