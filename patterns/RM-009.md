# RM-009: memcg accounting

**Risk**: Incorrect memory accounting

**When to check**: Mandatory when page, slab or vmalloc APIs are used (skip otherwise)

**Notes**:
- by default most usage charges memory to the task's memcg
- slabs created with SLAB_ACCOUNT implicitly have __GFP_ACCOUNT on every allocation

Place each step defined below into TodoWrite.

**Mandatory memcg accounting validation:**
- step 1: read entire function definition
  - Add function to TodoWrite
  - Output: function name, and a random line from anywhere in the definition
    - you must prove you read the function
- step 2: check all allocations in modified functions, even if they didn't change
  - Add every allocation to TodoWrite
  - Output allocation line in code
- step 3: when using __GFP_ACCOUNT, ensure the correct memcg is charged
  - old = set_active_memcg(memcg) ; work ; set_active_memcg(old)
- step 4: most usage does not need set_active_memcg(), but:
  - kthreads switching context between many memcgs may need it
  - helpers operating on objects (e.g., BPF maps) with stored memcg may need it
- step 5: ensure new __GFP_ACCOUNT usage is consistent with surrounding code

**After analysis:** Issues found: [none OR list]
