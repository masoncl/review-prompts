# CL-001: Lock type and ordering

**Risk**: Deadlock/sleep bug

**When to check:** Mandatory when locking is used

**Pattern-specific TodoWrite fields**:
- Locks taken: [name] - [type: spin_lock/mutex/etc] at [line]
- Context validation: Sleep in atomic [YES/NO], IRQ context possible [YES/NO], Lock variant correct [YES/NO]
- Lock ordering: Lock chain [lock1 -> lock2], Other chains found [list], ABBA deadlock [YES/NO]
- Trylock→lock conversion: Present [YES/NO], Deadlock introduced [YES/NO]

**Mandatory lock type validation:**
- read entire function definition when locking is used
- track every lock taken in modified functions in TodoWrite, even if they didn't change
- never sleep (mutex/rwsem/schedule/sleeping allocations) in atomic context
- use _irqsave if any lock holder is called from IRQ context
- check to make sure all users properly select _irq variants
- document and verify lock ordering when multiple locks held
  - track all multiple lock chains in a TodoWrite, verify no ABBA
- verify trylock→lock conversion does not introduce deadlock scenarios

**Mandatory Self-verification gate:**

**Pattern-specific questions**:
  1. How many functions sleep in atomic context? [number]
  2. How many functions need _irqsave but don't use it? [number]
  3. How many lock chains have ABBA deadlock potential? [number]
  4. Have you verified ALL lock orderings? [yes/no]

If you cannot answer ALL questions with evidence, RESTART CL-001 from the beginning.
